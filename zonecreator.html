<!--
  Zone Creator Web Interface

  Description:
  This web page allows users to dynamically create and configure zone definitions for Lua-based missions,
  such as those used in DCS or similar simulations. Users can:

  - Upload an `init.lua` file to extract preset upgrade paths
  - Define a new zone with name, side, and options like helicopter/plane spawn
  - Add multiple upgrade or product presets with zone-prefixed naming
  - Generate a Lua snippet ready to paste into mission scripts
  - View code in raw or syntax-highlighted form and copy to clipboard

  Built with: Bootstrap 5, jQuery, Highlight.js
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pretense Mission Zone Creator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">-->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js">
    </script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Light -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Dark -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/darkly/bootstrap.min.css" rel="stylesheet">

    <!-- Preset Templates -->
    <script src="templates.js"></script>
    <style>
        textarea {
            height: 600px;
            resize: vertical;
            display: none;
        }

        pre code.hljs {
            padding: 1rem;
            background: #f8f9fa;
            display: block;
            height: 600px;
            overflow-y: auto;
        }

        .text-red {
            color: #dc3545;
        }

        .text-blue {
            color: #0d6efd;
        }

        .radio-highlight-red:has(input:checked) {
            background-color: #f8d7da;
            border-radius: 5px;
        }

        .radio-highlight-blue:has(input:checked) {
            background-color: #cfe2ff;
            border-radius: 5px;
        }

        .left-scroll {
            max-height: 90vh;
            overflow-y: auto;
            padding-right: 1rem; /* avoid scrollbar overlap */
        }

        textarea {
            width: 100%;
            height: 100%;
            resize: none; /* optional: disables manual resizing */
        }

        #highlightContainer {
            white-space: pre-wrap;     /* enables wrapping at whitespace */
            word-break: break-word;    /* breaks long words */
            overflow-wrap: break-word; /* ensures wrapping works in all browsers */
        }


    </style>
</head>
<body class="container-fluid py-4">

<h1 class="mb-4">‚úàÔ∏è Pretense Zone Creator</h1>
<div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

<div class="row">
    <div class="col-md-7 left-scroll">
        <div id="zoneForm" class="mb-4">
            <div class="mb-3">
                <label for="initFile" class="form-label">Upload init.lua to load presets</label>
                <input type="file" id="initFile" class="form-control" accept=".lua">
            </div>
            <button id="addZone" class="btn btn-success mb-3">‚ûï Add Zone</button>
            <div class="accordion" id="zonesList">
                <!-- ZONES will show up here -->
            </div>
        </div>
    </div>

    <div class="col-md-5">

        <div class="mb-1 d-flex">
            <h4 for="output" class="form-label">Generated Lua Snippet</h4>
        </div>
        <button id="generateLua" class="btn btn-primary mb-3">Generate Lua Code</button>
        <div class="mb-2 d-flex gap-2">
            <button id="toggleView" class="btn btn-outline-secondary btn-sm">Toggle View</button>
            <button id="copyCode" class="btn btn-outline-success btn-sm">Copy</button>
        </div>
        <div class="h-100 w-100">
            <pre id="highlightContainer">
                <code id="highlightedLua" class="theme-atom-on-dark bg-dark lua"></code></pre>
        </div>
        <textarea id="output" wrap="soft" readonly class="form-control bg-light"></textarea>
    </div>
</div>

<script>
    hljs.highlightAll();

    //Default Options
    let presetOptions = [
        "presets.defenses.blue.ewr1",
        "presets.defenses.blue.hawk",
        "presets.defenses.blue.infantry1",
        "presets.defenses.blue.infantry2",
        "presets.defenses.blue.infantry3",
        "presets.defenses.blue.shorad1",
        "presets.defenses.blue.shorad2",
        "presets.defenses.blue.shorad3",
        "presets.defenses.red.ewr1",
        "presets.defenses.red.ewr2",
        "presets.defenses.red.infantry1",
        "presets.defenses.red.infantry2",
        "presets.defenses.red.infantry3",
        "presets.defenses.red.sa2",
        "presets.defenses.red.sa3",
        "presets.defenses.red.sa5",
        "presets.defenses.red.sa6",
        "presets.defenses.red.shorad1",
        "presets.defenses.red.shorad2",
        "presets.defenses.red.shorad3",
        "presets.missions.attack.cas",
        "presets.missions.attack.helo",
        "presets.missions.attack.sead",
        "presets.missions.attack.strike",
        "presets.missions.attack.surface",
        "presets.missions.patrol.aircraft",
        "presets.missions.supply.convoy",
        "presets.missions.supply.helo",
        "presets.missions.supply.transfer",
        "presets.special.blue.infantry",
        "presets.special.red.infantry"
    ];
    let presetUpgradeOptions = [
        "presets.upgrades.airdef.comCenter",
        "presets.upgrades.attack.ammoCache",
        "presets.upgrades.basic.comPost",
        "presets.upgrades.basic.tent",
        "presets.upgrades.supply.ammoDepot",
        "presets.upgrades.supply.antenna",
        "presets.upgrades.supply.excavator",
        "presets.upgrades.supply.factory",
        "presets.upgrades.supply.factoryTank",
        "presets.upgrades.supply.farm",
        "presets.upgrades.supply.fuelCache",
        "presets.upgrades.supply.fuelTank",
        "presets.upgrades.supply.hq",
        "presets.upgrades.supply.oilPump",
        "presets.upgrades.supply.powerplant1",
        "presets.upgrades.supply.powerplant2",
        "presets.upgrades.supply.refinery1"
    ];

    function fillTemplate(template, values) {
        console.log(values)
        return template.replace(/{{(\w+)}}/g, (_, key) => values[key] ?? '');
    }

    let zoneIndex = 0;


    /** Create ZONE **/
    function createZoneForm(index) {
        const zoneForm = $(
            `
    <div id="zoneForm${index+1}" class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button zone-heading" type="button" data-bs-toggle="collapse" data-bs-target="#zonecollapse${index + 1}" aria-expanded="true" aria-controls="zonecollapse${index + 1}">
                Zone ${index + 1}
            </button>
        </h2>
        <div id="zonecollapse${index + 1}" class="accordion-collapse collapse show" data-bs-parent="#zoneList">
            <div class="accordion-body zone-container" data-zone-index="${index}">
                <h4 class="mb-3 zone-label">Zone ${index + 1}</h4>
                <div class="text-end">
                  <button type="button" class="btn btn-sm btn-danger remove-zone">Remove Zone</button>
                </div>
                <div class="mb-3">
                    <label for="zoneName${index}" class="form-label">Zone Name *</label>
                    <input type="text" id="zoneName${index}" data-zone-name-index="${index+1}" class="zone-name-input form-control">
                </div>

                <div class="mb-3">
                    <label class="form-label">Initial Side *</label>
                    <div class="d-flex gap-3">
                        <div class="form-check form-check-inline radio-highlight-red">
                            <input class="form-check-input" type="radio" name="side" id="sideRed" value="1">
                            <label class="form-check-label text-red" for="sideRed">Red (1)</label>
                        </div>
                        <div class="form-check form-check-inline radio-highlight-blue">
                            <input class="form-check-input" type="radio" name="side" id="sideBlue" value="2">
                            <label class="form-check-label text-blue" for="sideBlue">Blue (2)</label>
                        </div>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label">Zone Type</label>
                    <select class="form-select zoneTypeSelect">
                    </select>
                    <input type="hidden" class="zoneTypeTemplate">
                </div>

                <div class="custom-controls">
                    <div class="form-check mb-2">
                        <input type="checkbox" id="keepActive" class="form-check-input">
                        <label class="form-check-label" for="keepActive">Keep Active</label>
                    </div>

                    <div class="form-check mb-2">
                        <input type="checkbox" id="heloSpawn" class="form-check-input">
                        <label class="form-check-label" for="heloSpawn">üöÅ Helicopter Spawn</label>
                    </div>

                    <div class="form-check mb-2">
                        <input type="checkbox" id="planeSpawn" class="form-check-input">
                        <label class="form-check-label" for="planeSpawn">‚úàÔ∏è Plane Spawn</label>
                    </div>

                    <div class="mb-3">
                        <label for="maxResource" class="form-label">Max Resource (optional)</label>
                        <input type="text" id="maxResource" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label for="airbaseName" class="form-label">Airbase Name (optional)</label>
                        <input type="text" id="airbaseName" class="form-control">
                    </div>

                    <h4 class="mt-4">Upgrade Levels</h4>
                    <div id="upgrade-levels" class="mb-3 upgrade-levels"></div>
                    <button type="button" id="addUpgradeLevel" class="btn btn-secondary mb-3 add-upgrade-level" data-upgrade-level-button="${index}">Add Upgrade Level</button>
                </div>
            </div>
        </div>
    </div>
<!--    <div class="zone-container border rounded p-3 mb-4" data-zone-index="${index}">-->

      `
        );

        // Populate dropdown
        const templateSelect = zoneForm.find('.zoneTypeSelect');
        const hiddenInput = zoneForm.find('.zoneTypeTemplate');
        templateSelect.append(`<option value="custom">Custom</option>`);
        Object.keys(upgrade_templates).forEach(key => {
            templateSelect.append(`<option value="${key}">${key}</option>`);
        });


        // Show/hide controls based on selection
        templateSelect.on('change', function () {
            const val = $(this).val();
            if (val === 'custom') {
                zoneForm.find('.custom-controls').removeClass('d-none');
                hiddenInput.val('');
            } else {
                zoneForm.find('.custom-controls').addClass('d-none');
                const selected = $(this).val();
                console.log(selected)
                temp_string = upgrade_templates[selected]
                let rawZoneName = zoneForm.find('.zone-name-input').val().trim();
                let zone_name = rawZoneName.toLowerCase();
                hiddenInput.val(fillTemplate(temp_string, {zoneName: zone_name, rawZoneName: rawZoneName}));
            }
        });

        return zoneForm;
    }

    $(document).on('change','.zone-name-input',function(){
        // console.log('yo')
        let label = $(this).val().trim()
        const levelIndex = $(this).attr('data-zone-name-index');
        // console.log($('#zoneForm'+levelIndex).find('.zone-label'));

        $('#zoneForm'+levelIndex).find('.zone-label').text(label)
        $('#zoneForm'+levelIndex).find('.zone-heading').text(label)
    })

    $('#addZone').click(function () {
        const zoneForm = createZoneForm(zoneIndex);
        $('#zonesList').append(zoneForm);
        zoneIndex++;
    });


    function getSideName(side) {
        return side == 1 ? 'red' : 'blue'
    }

    function populatePresetUpgradeDropdown(selectElement) {
        selectElement.empty();
        selectElement.append('<option value="">-- Select Preset --</option>');
        presetUpgradeOptions.forEach(option => {
            selectElement.append(`<option value="${option}">${option}</option>`);
        });
    }

    function populatePresetProductDropdown(selectElement) {
        selectElement.empty();
        selectElement.append('<option value="">-- Select Preset --</option>');
        presetOptions.forEach(option => {
            selectElement.append(`<option value="${option}">${option}</option>`);
        });
    }

    $(document).ready(function () {
        $('#initFile').on('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                const matches = content.match(/presets\.[a-zA-Z0-9_\.]+/g);
                if (matches) {
                    presetOptions = [...new Set(matches)].sort();
                }
                const upgradeMatches = content.match(/presets.upgrades\.[a-zA-Z0-9_\.]+/g);
                if (upgradeMatches) {
                    presetUpgradeOptions = [...new Set(upgradeMatches)].sort();
                }

                presetOptions = presetOptions.filter(item => !presetUpgradeOptions.includes(item));
                console.log(presetUpgradeOptions);
                console.log(presetOptions);
            };
            reader.readAsText(file);
        });

        // UPGRADE LEVELS
// Reusable function to create a product item
        function createProductItem() {
            const productDiv = $(`
    <div class="card mb-2 product-item">
      <div class="card-body py-2">
        <div class="mb-2">
          <label class="form-label">Product Preset *</label>
          <select class="form-select productDropdown"></select>
        </div>
        <div class="mb-2">
          <label class="form-label">Product Name *</label>
          <input type="text" class="form-control productName">
        </div>
        <div class="optionalMissionFields d-none mt-2">
          <label class="form-label">Optional Mission Fields</label>
          <div class="mb-2"><input type="number" class="form-control" placeholder="Altitude (optional)" name="altitude"></div>
          <div class="mb-2"><input type="number" class="form-control" placeholder="Range (optional)" name="range"></div>
          <div class="mb-2"><input type="text" class="form-control" placeholder="Frequency (optional)" name="freq"></div>
          <div class="mb-2"><input type="text" class="form-control" placeholder="TACAN (optional)" name="tacan"></div>
          <div class="mb-2"><input type="text" class="form-control" placeholder="Variant (optional)" name="variant"></div>
          <div class="mb-2">
            <select class="form-select" name="expend">
              <option value="">Expend (optional)</option>
              <option value="AI.Task.WeaponExpend.ALL">AI.Task.WeaponExpend.ALL</option>
              <option value="AI.Task.WeaponExpend.ONE">AI.Task.WeaponExpend.ONE</option>
            </select>
          </div>
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger remove-product">Remove Product</button>
        </div>
      </div>
    </div>
  `);

            // Auto-fill name from selected preset
            productDiv.find('.productDropdown').on('change', function () {
                const selected = $(this).val();
                const name = selected.split('.').pop();
                productDiv.find('.productName').val(name);

                // Show/hide mission fields based on `.missions.` match
                if (selected.includes('.missions.')) {
                    productDiv.find('.optionalMissionFields').removeClass('d-none');
                } else {
                    productDiv.find('.optionalMissionFields').addClass('d-none');
                }
            });

            return productDiv;
        }



// Reusable function to create an upgrade item with nested products
        function createUpgradeCard() {
            const upgradeCard = $(`
    <div class="card mb-3 ms-5 upgrade-item">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Choose Preset *</label>
          <select class="form-select presetDropdown"></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Preset Name (will be prefixed with Zone name and suffixed by side) *</label>
          <input type="text" class="form-control extendedName">
        </div>

        <div class="mb-2">
          <label class="form-label">Products for this Upgrade:</label>
          <div class="products-list mb-2"></div>
          <button type="button" class="btn btn-sm btn-info add-product">Add Product</button>
        </div>

        <div class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger remove-upgrade">Remove Upgrade</button>
        </div>
      </div>
    </div>
  `);

            // Add logic to auto-fill the extendedName field
            upgradeCard.find('.presetDropdown').on('change', function () {
                const selected = $(this).val();
                const name = selected.split('.').pop(); // extract after last dot
                upgradeCard.find('.extendedName').val(name);
            });

            return upgradeCard;
        }


// Update upgrade level index and nested references
        function updateUpgradeLevelIndexes(upgrade_levels) {
            // console.log(upgrade_levels);
            upgrade_levels.find('.upgradeLevel').each(function (index) {
                // console.log(this)
                let print_index = index + 1;
                // console.log(print_index);
                $(this).attr('id', `upgradeLevel-${print_index}`);
                $(this).find('h5').text(`Level ${print_index}`);
                $(this).find('[id^="upgrades-"]').attr('id', `upgrades-${index}`);
                $(this).find('[data-upgrade-button]').attr('data-upgrade-button', index);
                if (print_index>1) {
                    $(this).find('.duplicate-upgrade-level').addClass('d-none');
                } else {
                    $(this).find('.duplicate-upgrade-level').removeClass('d-none');
                }

            });
        }

// Add upgrade level
        $(document).on('click', '.add-upgrade-level', function () {

            const upgradeContainer = $(this).closest('.zone-container');
            const upgradeLevels = upgradeContainer.find('.upgradeLevel');
            const addButton = $(this);

            if (upgradeLevels.length >= 2) {
                addButton.prop('disabled', true);
                return;
            }

            // console.log(this)
            const index = $(this).parent().find('.upgradeLevel').length+1;
            // console.log(index);
            const upgradeLevelDiv = $(`
                <div id="upgradeLevel-${index}" class="upgradeLevel ms-5 mb-2">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5>Level ${index}</h5>
                    <div class="btn-group gap-4">
                      <button type="button" class="btn btn-sm btn-primary duplicate-upgrade-level">Duplicate</button>
                      <button type="button" class="btn btn-sm btn-danger remove-upgrade-level">Remove</button>
                    </div>

                  </div>
                  <div id="upgrades-${index}" class="upgrades-list mb-2"></div>
                  <button type="button" class="btn btn-sm btn-secondary add-upgrade" data-upgrade-button="${index}">Add Upgrade Preset</button>
                  <hr/>
                </div>
              `);

            if (index > 1) {
                // Remove the duplicate button
                upgradeLevelDiv.find('.duplicate-upgrade-level').addClass('d-none');
            }

            $(this).parent().find('.upgrade-levels').append(upgradeLevelDiv);
            // Disable add button if now at max
            if (upgradeContainer.find('.upgradeLevel').length >= 2) {
                addButton.prop('disabled', true);
            }
        });

// Remove upgrade level
        $(document).on('click', '.remove-upgrade-level', function () {
            let upgrade_container = $(this).closest('.upgrade-levels')
            // console.log(upgrade_container)
            $(this).closest('.upgradeLevel').remove();
            updateUpgradeLevelIndexes(upgrade_container);

            // Re-enable the "Add Upgrade Level" button
            upgrade_container.parent().find('.add-upgrade-level').prop('disabled', false);

            // Regenerate LUA
            $('#generateLua').trigger('click');
        });

// Add upgrade preset to upgrade level
        $(document).on('click', '.add-upgrade', function () {
            const levelIndex = $(this).attr('data-upgrade-button');
            // console.log(levelIndex);
            const container = $(this).parent().find(`#upgrades-${levelIndex}`);
            const upgradeDiv = createUpgradeCard();
            container.append(upgradeDiv);
            populatePresetUpgradeDropdown(upgradeDiv.find('.presetDropdown'));
        });

// Remove upgrade
        $(document).on('click', '.remove-upgrade', function () {
            $(this).closest('.upgrade-item').remove();
            // Regenerate LUA
            $('#generateLua').trigger('click');
        });

// Add product to specific upgrade
        $(document).on('click', '.add-product', function () {
            const productDiv = createProductItem();
            const container = $(this).closest('.upgrade-item').find('.products-list');
            container.append(productDiv);
            populatePresetProductDropdown(productDiv.find('.productDropdown'));
        });

// Remove product
        $(document).on('click', '.remove-product', function () {
            $(this).closest('.product-item').remove();
            // Regenerate LUA
            $('#generateLua').trigger('click');
        });


// Handle removing upgrades
        $(document).on('click', '.remove-upgrade', function () {
            $(this).closest('.upgrade-item').remove();
            // Regenerate LUA
            $('#generateLua').trigger('click');
        });

//Duplicate Levels
        $(document).on('click', '.duplicate-upgrade-level', function () {
            const original = $(this).closest('.upgradeLevel');
            const clone = original.clone(false, false); // clone without events

            // Manually copy values from original to clone
            original.find('select').each(function (i) {
                const value = $(this).val();
                clone.find('select').eq(i).val(value);
            });
            original.find('input').each(function (i) {
                const value = $(this).val();
                clone.find('input').eq(i).val(value);
            });
            original.find('textarea').each(function (i) {
                const value = $(this).val();
                clone.find('textarea').eq(i).val(value);
            });

            // Append the clone
            $('#upgrade-levels').append(clone);

            // Rebind handlers manually if needed (only necessary if clone(false,false) used)
            clone.find('.presetDropdown').on('change', function () {
                const selected = $(this).val();
                const name = selected.split('.').pop();
                clone.find('.extendedName').val(name);
            });

            clone.find('.productDropdown').on('change', function () {
                const selected = $(this).val();
                const name = selected.split('.').pop();
                clone.find('.productName').val(name);

                if (selected.includes('.missions.')) {
                    clone.find('.optionalMissionFields').removeClass('d-none');
                } else {
                    clone.find('.optionalMissionFields').addClass('d-none');
                }
            });

            // Reindex all upgrade levels
            updateUpgradeLevelIndexes();
            // Regenerate LUA
            $('#generateLua').trigger('click');
        });




// LUA Generation
        $('#generateLua').click(function () {
            let fullLua = '';

            $('.zone-container').each(function () {
                const zoneIndex = $(this).data('zone-index');
                const rawZoneName = $(this).find('#zoneName'+zoneIndex).val().trim();
                const zoneKey = rawZoneName.toLowerCase().replace(/\s+/g, '_');

                if (!rawZoneName) return;

                let lua = `zones.${zoneKey} = ZoneCommand:new("${rawZoneName}")\n`;

                /////
                // let rawZoneName = $('#zoneName').val().trim();
                // let zoneKey = rawZoneName.toLowerCase().replace(/\s+/g, '_');
                // let lua = `zones.${zoneKey} = ZoneCommand:new("${rawZoneName}")\n`;


                let side = $(this).find('input[name="side"]:checked').val();

                if (!rawZoneName) {
                    $('#errorMessage').text('Zone Name is required.').removeClass('d-none');
                    return;
                } else {
                    $('#errorMessage').addClass('d-none').text('');
                }


                if (side !== undefined) {
                    lua += `zones.${zoneKey}.initialState = { side=${side} }\n`;
                }

                let isCustom = $(this).find('.zoneTypeSelect').val();
                if (isCustom !== 'custom') {

                    // Fill with template
                    let templateString = $(this).find('.zoneTypeTemplate').val();
                    lua += templateString;

                } else {

                    // EXTRACT All the Values
                    let keepActive = $(this).find('#keepActive').is(':checked');
                    let heloSpawn = $(this).find('#heloSpawn').is(':checked');
                    let planeSpawn = $(this).find('#planeSpawn').is(':checked');
                    let airbaseName = $(this).find('#airbaseName').val().trim();
                    let maxResourceValue = $(this).find('#maxResource').val().trim();

                    if (keepActive) {
                        lua += `zones.${zoneKey}.keepActive = true\n`;
                    }
                    if (heloSpawn) {
                        lua += `zones.${zoneKey}.isHeloSpawn = true\n`;
                    }
                    if (planeSpawn) {
                        lua += `zones.${zoneKey}.isPlaneSpawn = true\n`;
                    }
                    if (maxResourceValue) {
                        lua += `zones.${zoneKey}.maxResource = ${maxResourceValue}\n`;
                    }
                    if (airbaseName) {
                        lua += `zones.${zoneKey}.airbaseName = "${airbaseName}"\n`;
                    }

                    lua += `zones.${zoneKey}:defineUpgrades({\n`;

                    $(this).find('.upgradeLevel').each(function (levelIndex) {
                        lua += `    [${levelIndex + 1}] = {\n`;

                        const upgradeLines = [];

                        $(this).find('.upgrade-item').each(function () {
                            let presetPath = $(this).find('.presetDropdown').val();
                            let baseName = $(this).find('.extendedName').val().trim();
                            let sideColor = levelIndex===1 ? 'blue' : 'red'
                            let extendedName = `${zoneKey}-${baseName}-${sideColor}`;

                            if (presetPath && extendedName) {
                                const productLines = [];

                                p_count = 1
                                $(this).find('.product-item').each(function () {
                                    let productPath = $(this).find('.productDropdown').val();
                                    let productName = `${zoneKey}-${$(this).find('.productName').val().trim()}-${sideColor}-${p_count}`;

                                    if (productPath && productName) {
                                        const fields = [];

                                        // Extract optional mission field values
                                        const altitude = $(this).find('[name="altitude"]').val();
                                        const range = $(this).find('[name="range"]').val();
                                        const freq = $(this).find('[name="freq"]').val();
                                        const tacan = $(this).find('[name="tacan"]').val();
                                        const variant = $(this).find('[name="variant"]').val();
                                        const expend = $(this).find('[name="expend"]').val();

                                        // Always include name
                                        fields.push(`name='${productName}'`);
                                        if (altitude) fields.push(`altitude=${altitude}`);
                                        if (range) fields.push(`range=${range}`);
                                        if (freq) fields.push(`freq='${freq}'`);
                                        if (tacan) fields.push(`tacan='${tacan}'`);
                                        if (variant) fields.push(`variant='${variant}'`);
                                        if (expend) fields.push(`expend=${expend}`);

                                        productLines.push(`                     ${productPath}:extend({ ${fields.join(', ')} })`);
                                    }

                                    p_count += 1;
                                });

                                const productBlock = productLines.length
                                    ? `,\n                products = {\n${productLines.join(',\n')}\n                }`
                                    : '';

                                upgradeLines.push(
                                    `        ${presetPath}:extend({\n            name='${extendedName}'${productBlock}\n        })`
                                );
                            }
                        });

                        lua += upgradeLines.join(',\n') + (upgradeLines.length > 0 ? '\n' : '');
                        lua += `    }${levelIndex < $('.upgradeLevel').length - 1 ? ',' : ''}\n`;

                    });
                }

                lua += `})\n`;

                fullLua += lua + '\n';
            });



            $('#output').val(fullLua);
            $('#highlightedLua').text(fullLua);
            hljs.highlightElement(document.getElementById('highlightedLua'));
        });


        // Automatically trigger Lua generation on any input change
        $('#zonesList').on('input change', 'input, select, textarea', function () {
            $('#generateLua').trigger('click');
        });

        $('#zonesList').on('input change', function () {
            $('#errorMessage').addClass('d-none').text('');
        });



    });

    $('#highlightContainer').show();
    $('#output').hide();

    $('#toggleView').click(function () {
        $('#highlightContainer').toggle();
        $('#output').toggle();
    });

    $('#copyCode').click(function () {
        const luaText = $('#output').val();
        navigator.clipboard.writeText(luaText).then(() => {
            alert('Lua code copied to clipboard!');
        });
    });
</script>

</body>
</html>
