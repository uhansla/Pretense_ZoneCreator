<!--
  Zone Creator Web Interface

  Description:
  This web page allows users to dynamically create and configure zone definitions for Lua-based missions,
  such as those used in DCS or similar simulations. Users can:

  - Upload an `init.lua` file to extract preset upgrade paths
  - Define a new zone with name, side, and options like helicopter/plane spawn
  - Add multiple upgrade or product presets with zone-prefixed naming
  - Generate a Lua snippet ready to paste into mission scripts
  - View code in raw or syntax-highlighted form and copy to clipboard

  Built with: Bootstrap 5, jQuery, Highlight.js
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pretense Mission Zone Creator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">-->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js">
    </script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Light -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Dark -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/darkly/bootstrap.min.css" rel="stylesheet">

    <style>
        textarea {
            height: 600px;
            resize: vertical;
            display: none;
        }

        pre code.hljs {
            padding: 1rem;
            background: #f8f9fa;
            display: block;
            height: 600px;
            overflow-y: auto;
        }

        .text-red {
            color: #dc3545;
        }

        .text-blue {
            color: #0d6efd;
        }

        .radio-highlight-red:has(input:checked) {
            background-color: #f8d7da;
            border-radius: 5px;
        }

        .radio-highlight-blue:has(input:checked) {
            background-color: #cfe2ff;
            border-radius: 5px;
        }
    </style>
</head>
<body class="container-fluid py-4">

<h1 class="mb-4">‚úàÔ∏è Pretense Zone Creator</h1>
<div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

<div class="row">
    <div class="col-md-7">
        <div id="zoneForm" class="mb-4">
            <div class="mb-3">
                <label for="initFile" class="form-label">Upload init.lua to load presets</label>
                <input type="file" id="initFile" class="form-control" accept=".lua">
            </div>

            <div class="mb-3">
                <label for="zoneName" class="form-label">Zone Name *</label>
                <input type="text" id="zoneName" class="form-control">
            </div>

            <div class="mb-3">
                <label class="form-label">Initial Side *</label>
                <div class="d-flex gap-3">
                    <div class="form-check form-check-inline radio-highlight-red">
                        <input class="form-check-input" type="radio" name="side" id="sideRed" value="1">
                        <label class="form-check-label text-red" for="sideRed">Red (1)</label>
                    </div>
                    <div class="form-check form-check-inline radio-highlight-blue">
                        <input class="form-check-input" type="radio" name="side" id="sideBlue" value="2">
                        <label class="form-check-label text-blue" for="sideBlue">Blue (2)</label>
                    </div>
                </div>
            </div>

            <div class="form-check mb-2">
                <input type="checkbox" id="keepActive" class="form-check-input">
                <label class="form-check-label" for="keepActive">Keep Active</label>
            </div>

            <div class="form-check mb-2">
                <input type="checkbox" id="heloSpawn" class="form-check-input">
                <label class="form-check-label" for="heloSpawn">üöÅ Helicopter Spawn</label>
            </div>

            <div class="form-check mb-2">
                <input type="checkbox" id="planeSpawn" class="form-check-input">
                <label class="form-check-label" for="planeSpawn">‚úàÔ∏è Plane Spawn</label>
            </div>

            <div class="mb-3">
                <label for="maxResource" class="form-label">Max Resource (optional)</label>
                <input type="text" id="maxResource" class="form-control">
            </div>

            <div class="mb-3">
                <label for="airbaseName" class="form-label">Airbase Name (optional)</label>
                <input type="text" id="airbaseName" class="form-control">
            </div>

            <h4 class="mt-4">Upgrade Levels</h4>
            <div id="upgrade-levels" class="mb-3"></div>
            <button type="button" id="addUpgradeLevel" class="btn btn-secondary mb-3">Add Upgrade Level</button>
        </div>
    </div>

    <div class="col-md-5">

        <div class="mb-1 d-flex">
            <h4 for="output" class="form-label">Generated Lua Snippet</h4>
        </div>
        <button id="generateLua" class="btn btn-primary mb-3">Generate Lua Code</button>
        <div class="mb-2 d-flex gap-2">
            <button id="toggleView" class="btn btn-outline-secondary btn-sm">Toggle View</button>
            <button id="copyCode" class="btn btn-outline-success btn-sm">Copy</button>
        </div>
        <pre id="highlightContainer"><code id="highlightedLua" class="theme-atom-on-dark bg-dark lua"></code></pre>
        <textarea id="output" readonly class="form-control bg-light"></textarea>
    </div>
</div>

<script>
    hljs.highlightAll();
    let presetOptions = [];
    let presetUpgradeOptions = [];

    function getSideName(side) {
        return side == 1 ? 'red' : 'blue'
    }

    function populatePresetUpgradeDropdown(selectElement) {
        selectElement.empty();
        selectElement.append('<option value="">-- Select Preset --</option>');
        presetUpgradeOptions.forEach(option => {
            selectElement.append(`<option value="${option}">${option}</option>`);
        });
    }

    function populatePresetProductDropdown(selectElement) {
        selectElement.empty();
        selectElement.append('<option value="">-- Select Preset --</option>');
        presetOptions.forEach(option => {
            selectElement.append(`<option value="${option}">${option}</option>`);
        });
    }

    $(document).ready(function () {
        $('#initFile').on('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                const matches = content.match(/presets\.[a-zA-Z0-9_\.]+/g);
                if (matches) {
                    presetOptions = [...new Set(matches)].sort();
                }
                const upgradeMatches = content.match(/presets.upgrades\.[a-zA-Z0-9_\.]+/g);
                if (upgradeMatches) {
                    presetUpgradeOptions = [...new Set(upgradeMatches)].sort();
                }

                presetOptions = presetOptions.filter(item => !presetUpgradeOptions.includes(item));

            };
            reader.readAsText(file);
        });

        // UPGRADE LEVELS
// Reusable function to create a product item
        function createProductItem() {
            const productDiv = $(`
    <div class="card mb-2 product-item">
      <div class="card-body py-2">
        <div class="mb-2">
          <label class="form-label">Product Preset *</label>
          <select class="form-select productDropdown"></select>
        </div>
        <div class="mb-2">
          <label class="form-label">Product Name *</label>
          <input type="text" class="form-control productName">
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger remove-product">Remove Product</button>
        </div>
      </div>
    </div>
  `);

            // Auto-fill productName on preset selection
            productDiv.find('.productDropdown').on('change', function () {
                const selected = $(this).val();
                const name = selected.split('.').pop();
                productDiv.find('.productName').val(name);
            });

            return productDiv;
        }


// Reusable function to create an upgrade item with nested products
        function createUpgradeCard() {
            const upgradeCard = $(`
    <div class="card mb-3 ms-5 upgrade-item">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Choose Preset *</label>
          <select class="form-select presetDropdown"></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Preset Name (will be prefixed with Zone name and suffixed by side) *</label>
          <input type="text" class="form-control extendedName">
        </div>

        <div class="mb-2">
          <label class="form-label">Products for this Upgrade:</label>
          <div class="products-list mb-2"></div>
          <button type="button" class="btn btn-sm btn-info add-product">Add Product</button>
        </div>

        <div class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger remove-upgrade">Remove Upgrade</button>
        </div>
      </div>
    </div>
  `);

            // Add logic to auto-fill the extendedName field
            upgradeCard.find('.presetDropdown').on('change', function () {
                const selected = $(this).val();
                const name = selected.split('.').pop(); // extract after last dot
                upgradeCard.find('.extendedName').val(name);
            });

            return upgradeCard;
        }


// Update upgrade level index and nested references
        function updateUpgradeLevelIndexes() {
            $('.upgradeLevel').each(function (index) {
                $(this).attr('id', `upgradeLevel-${index+1}`);
                $(this).find('h3').text(`Level ${index}`);
                $(this).find('[id^="upgrades-"]').attr('id', `upgrades-${index}`);
                $(this).find('[data-upgrade-button]').attr('data-upgrade-button', index);
            });
        }

// Add upgrade level
        $('#addUpgradeLevel').click(function () {
            const index = $('.upgradeLevel').length+1;
            const upgradeLevelDiv = $(`
    <div id="upgradeLevel-${index}" class="upgradeLevel ms-5 mb-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Level ${index}</h5>
        <button type="button" class="btn btn-sm btn-outline-danger remove-upgrade-level">Remove</button>
      </div>
      <div id="upgrades-${index}" class="upgrades-list mb-2"></div>
      <button type="button" class="btn btn-sm btn-secondary add-upgrade" data-upgrade-button="${index}">Add Upgrade</button>
      <hr/>
    </div>
  `);
            $('#upgrade-levels').append(upgradeLevelDiv);
        });

// Remove upgrade level
        $(document).on('click', '.remove-upgrade-level', function () {
            $(this).closest('.upgradeLevel').remove();
            updateUpgradeLevelIndexes();
        });

// Add upgrade to upgrade level
        $(document).on('click', '.add-upgrade', function () {
            const levelIndex = $(this).attr('data-upgrade-button');
            const container = $(`#upgrades-${levelIndex}`);
            const upgradeDiv = createUpgradeCard();
            container.append(upgradeDiv);
            populatePresetUpgradeDropdown(upgradeDiv.find('.presetDropdown'));
        });

// Remove upgrade
        $(document).on('click', '.remove-upgrade', function () {
            $(this).closest('.upgrade-item').remove();
        });

// Add product to specific upgrade
        $(document).on('click', '.add-product', function () {
            const productDiv = createProductItem();
            const container = $(this).closest('.upgrade-item').find('.products-list');
            container.append(productDiv);
            populatePresetProductDropdown(productDiv.find('.productDropdown'));
        });

// Remove product
        $(document).on('click', '.remove-product', function () {
            $(this).closest('.product-item').remove();
        });


// Handle removing upgrades
        $(document).on('click', '.remove-upgrade', function () {
            $(this).closest('.upgrade-item').remove();
        });

        $('#generateLua').click(function () {
            let rawZoneName = $('#zoneName').val().trim();
            let zoneKey = rawZoneName.toLowerCase().replace(/\s+/g, '_');

            let side = $('input[name="side"]:checked').val();
            let keepActive = $('#keepActive').is(':checked');
            let heloSpawn = $('#heloSpawn').is(':checked');
            let planeSpawn = $('#planeSpawn').is(':checked');
            let airbaseName = $('#airbaseName').val().trim();
            let maxResourceValue = $('#maxResource').val().trim();

            if (!rawZoneName) {
                $('#errorMessage').text('Zone Name is required.').removeClass('d-none');
                return;
            } else {
                $('#errorMessage').addClass('d-none').text('');
            }


            let lua = `zones.${zoneKey} = ZoneCommand:new("${rawZoneName}")\n`;

            if (side !== undefined) {
                lua += `zones.${zoneKey}.initialState = { side=${side} }\n`;
            }
            if (keepActive) {
                lua += `zones.${zoneKey}.keepActive = true\n`;
            }
            if (heloSpawn) {
                lua += `zones.${zoneKey}.isHeloSpawn = true\n`;
            }
            if (planeSpawn) {
                lua += `zones.${zoneKey}.isPlaneSpawn = true\n`;
            }
            if (maxResourceValue) {
                lua += `zones.${zoneKey}.maxResource = ${maxResourceValue}\n`;
            }
            if (airbaseName) {
                lua += `zones.${zoneKey}.airbaseName = "${airbaseName}"\n`;
            }

            lua += `zones.${zoneKey}:defineUpgrades({\n`;

            $('.upgradeLevel').each(function (levelIndex) {
                lua += `    [${levelIndex + 1}] = {\n`;

                const upgradeLines = [];

                $(this).find('.upgrade-item').each(function () {
                    let presetPath = $(this).find('.presetDropdown').val();
                    let baseName = $(this).find('.extendedName').val().trim();
                    let extendedName = `${zoneKey}-${baseName}-${getSideName(side)}`;

                    if (presetPath && extendedName) {
                        const productLines = [];

                        p_count = 1
                        $(this).find('.product-item').each(function () {
                            let productPath = $(this).find('.productDropdown').val();
                            let productName = `${zoneKey}-${$(this).find('.productName').val().trim()}-${getSideName(side)}-${p_count}`;
                            if (productPath && productName) {
                                productLines.push(`                     ${productPath}:extend({ name='${productName}' })`);
                            }
                            p_count += 1;
                        });

                        const productBlock = productLines.length
                            ? `,\n                products = {\n${productLines.join(',\n')}\n                }`
                            : '';

                        upgradeLines.push(
                            `        ${presetPath}:extend({\n            name='${extendedName}'${productBlock}\n        })`
                        );
                    }
                });

                lua += upgradeLines.join(',\n') + (upgradeLines.length > 0 ? '\n' : '');
                lua += `    }${levelIndex < $('.upgradeLevel').length - 1 ? ',' : ''}\n`;

            });

            lua += `})\n`;

            $('#output').val(lua);
            $('#highlightedLua').text(lua);
            hljs.highlightElement(document.getElementById('highlightedLua'));
        });


        // Automatically trigger Lua generation on any input change
        $('#zoneForm').on('input change', 'input, select, textarea', function () {
            $('#generateLua').trigger('click');
        });

        $('#zoneForm').on('input change', function () {
            $('#errorMessage').addClass('d-none').text('');
        });



    });

    $('#highlightContainer').show();
    $('#output').hide();

    $('#toggleView').click(function () {
        $('#highlightContainer').toggle();
        $('#output').toggle();
    });

    $('#copyCode').click(function () {
        const luaText = $('#output').val();
        navigator.clipboard.writeText(luaText).then(() => {
            alert('Lua code copied to clipboard!');
        });
    });
</script>

</body>
</html>
