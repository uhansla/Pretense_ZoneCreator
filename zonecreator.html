<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zone Creator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container py-4">

<h1 class="mb-4">Zone Creator</h1>

<div id="zoneForm" class="mb-4">
    <div class="mb-3">
        <label for="zoneName" class="form-label">Zone Name</label>
        <input type="text" id="zoneName" class="form-control">
    </div>

    <div class="mb-3">
        <label for="side" class="form-label">Initial Side</label>
        <select id="side" class="form-select">
            <option value="">None</option>
            <option value="1">Red (1)</option>
            <option value="2">Blue (2)</option>
        </select>
    </div>

    <div class="form-check mb-2">
        <input type="checkbox" id="keepActive" class="form-check-input">
        <label class="form-check-label" for="keepActive">Keep Active</label>
    </div>

    <div class="form-check mb-2">
        <input type="checkbox" id="heloSpawn" class="form-check-input">
        <label class="form-check-label" for="heloSpawn">Helicopter Spawn</label>
    </div>

    <div class="form-check mb-2">
        <input type="checkbox" id="planeSpawn" class="form-check-input">
        <label class="form-check-label" for="planeSpawn">Plane Spawn</label>
    </div>

    <div class="mb-3">
        <label for="airbaseName" class="form-label">Airbase Name (optional)</label>
        <input type="text" id="airbaseName" class="form-control">
    </div>

    <div class="mb-3">
        <label for="initFile" class="form-label">Upload init.lua to load presets</label>
        <input type="file" id="initFile" class="form-control" accept=".lua">
    </div>

    <h2 class="mt-4">Upgrades</h2>
    <div id="upgrades" class="mb-3"></div>
    <button type="button" id="addUpgrade" class="btn btn-secondary mb-3">Add Upgrade</button>

    <button id="generateLua" class="btn btn-primary">Generate Lua Code</button>
</div>

<textarea id="output" readonly class="form-control" placeholder="Your generated Lua code will appear here..."></textarea>

<script>
    let presetOptions = [];

    function populatePresetDropdown(selectElement) {
        selectElement.empty();
        selectElement.append('<option value="">-- Select Preset --</option>');
        presetOptions.forEach(option => {
            selectElement.append(`<option value="${option}">${option}</option>`);
        });
    }

    $(document).ready(function() {
        $('#initFile').on('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const matches = content.match(/presets\.[a-zA-Z0-9_\.]+/g);
                if (matches) {
                    presetOptions = [...new Set(matches)].sort();
                    alert('Presets loaded: ' + presetOptions.length);
                } else {
                    alert('No presets found in file.');
                }
            };
            reader.readAsText(file);
        });

        $('#addUpgrade').click(function() {
            const upgradeDiv = $(`
        <div class="card mb-3">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Choose Preset</label>
              <select class="form-select presetDropdown"></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Extended Name</label>
              <input type="text" class="form-control extendedName">
            </div>
          </div>
        </div>
      `);
            $('#upgrades').append(upgradeDiv);
            populatePresetDropdown(upgradeDiv.find('.presetDropdown'));
        });

        $('#generateLua').click(function() {
            let zoneName = $('#zoneName').val().trim();
            let side = $('#side').val();
            let keepActive = $('#keepActive').is(':checked');
            let heloSpawn = $('#heloSpawn').is(':checked');
            let planeSpawn = $('#planeSpawn').is(':checked');
            let airbaseName = $('#airbaseName').val().trim();

            if (!zoneName) {
                alert('Zone Name is required.');
                return;
            }

            let lua = `zones.${zoneName} = ZoneCommand:new("${zoneName}")\n`;

            if (side !== "") {
                lua += `zones.${zoneName}.initialState = { side=${side} }\n`;
            }
            if (keepActive) {
                lua += `zones.${zoneName}.keepActive = true\n`;
            }
            if (heloSpawn) {
                lua += `zones.${zoneName}.isHeloSpawn = true\n`;
            }
            if (planeSpawn) {
                lua += `zones.${zoneName}.isPlaneSpawn = true\n`;
            }
            if (airbaseName) {
                lua += `zones.${zoneName}.airbaseName = "${airbaseName}"\n`;
            }

            lua += `zones.${zoneName}:defineUpgrades({\n`;
            lua += `    [1] = {\n`;

            $('.upgrade-item, .card-body').each(function() {
                let presetPath = $(this).find('.presetDropdown').val();
                let extendedName = $(this).find('.extendedName').val().trim();
                if (presetPath && extendedName) {
                    lua += `        ${presetPath}:extend({ name='${extendedName}' }),\n`;
                }
            });

            lua += `    }\n})\n`;

            $('#output').val(lua);
        });
    });
</script>

</body>
</html>